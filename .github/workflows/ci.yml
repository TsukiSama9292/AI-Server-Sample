name: ğŸ› ï¸ CI Pipeline

on:
  push:
    branches:
      - dev
  workflow_dispatch: # ğŸ–±ï¸ æ‰‹å‹•è§¸ç™¼

jobs:
  ci:
    runs-on: ubuntu-vm-ci # ci
    steps:
      # ğŸ” æª¢æŸ¥ç¨‹å¼ç¢¼ï¼Œæ‹‰å–æœ€æ–°çš„ç¨‹å¼ç¢¼
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v2
      
      # ğŸŒ ç’°å¢ƒè®Šæ•¸è¨­å®š
      - name: ğŸŒ± Set Environment Variables
        run: |
          echo "Setting environment variables..."
          cp docker-compose/.env.example docker-compose/.env
          echo -e "\nOLLAMA_API_URL=http://${{ secrets.OLLAMA_SERVICE_IP_PORT }}" >> ./fastapi/.env
      
      # ğŸ—ï¸ å»ºç½®æ‡‰ç”¨ç¨‹å¼é¡åƒ
      - name: ğŸ› ï¸ Build Application
        run: |
          echo "Building Docker Image..."
          docker-compose -f docker-compose-server.yml build --no-cache --pull
      
      # â–¶ï¸ å•Ÿå‹•å®¹å™¨ç¾¤ï¼Œç­‰å¾… 5 ç§’ç¢ºä¿å•Ÿå‹•å®Œæˆ
      - name: ğŸš€ Start Application
        run: |
          echo "Starting Docker Containers..."
          docker-compose -f docker-compose-server.yml up -d
          sleep 5
      
      # âœ… åŸ·è¡Œæ¸¬è©¦
      - name: ğŸ§ª Run Tests
        run: |
          echo "Running Tests..."
          docker exec ai_server_sample_fastapi bash -c "source /venv/.venv/bin/activate && pytest -s"
          echo "Tests completed!"
      
      # â¹ï¸ åœæ­¢å®¹å™¨ç¾¤
      - name: ğŸ›‘ Clear Application
        if: always()
        run: |
          docker-compose -f docker-compose-server.yml down
      
      # ğŸ§¹ æ¸…ç† Docker è³‡æº
      - name: ğŸ§¹ Clean up Docker
        if: always()
        run: |
          docker buildx prune --all --force
          docker system prune -af
          docker volume prune -f