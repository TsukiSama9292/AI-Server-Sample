name: ğŸš€ CD Pipeline

on:
  push:
    branches:
      - main
  workflow_dispatch: # ğŸ–±ï¸ å…è¨±æ‰‹å‹•è§¸ç™¼å·¥ä½œæµç¨‹

jobs:
  cd:
    runs-on: cd
    steps: # ğŸ› ï¸ åŸ·è¡Œæ­¥é©Ÿ
      # ğŸ” æª¢æŸ¥ç¨‹å¼ç¢¼ï¼Œæ‹‰å–æœ€æ–°çš„ç¨‹å¼ç¢¼
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v2
      
      # ğŸŒ ç’°å¢ƒè®Šæ•¸è¨­å®š
      - name: ğŸŒ± Set Environment Variables
        run: |
          echo "Setting environment variables..."
          cp .env.example .env
      
      # ğŸ³ å•Ÿç”¨ Ollama å®¹å™¨
      - name: âš¡ Start Ollama Container
        run: |
          echo "Starting Ollama Container..."
          docker compose -f docker-compose-ollama.yml up -d
          
      # ğŸ—ï¸ å»ºç«‹å¿…é ˆè¦çš„é¡åƒï¼Œæ­¤è™•åªéœ€è¦å»ºç«‹ FastAPI çš„é¡åƒ
      - name: ğŸ› ï¸ Build Application
        run: |
          echo "Building Docker Image..."
          docker compose -f docker-compose-server.yml build --no-cache --pull
      
      # â–¶ï¸ å•Ÿå‹•å®¹å™¨ç¾¤
      - name: ğŸš€ Start Application
        run: |
          docker compose -f docker-compose-server.yml up -d
      
      # ğŸ§¹ æ¸…ç† Docker è³‡æº
      - name: ğŸ§¹ Clean up Docker
        if: always()
        run: |
          docker buildx prune --all --force
          docker system prune -af
          docker volume prune -f